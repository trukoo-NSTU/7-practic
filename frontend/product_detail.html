<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">Загрузка...</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
        }
        
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            padding: 1rem 0;
        }
        
        .navbar-brand {
            font-weight: 800;
            font-size: 1.8rem;
            color: var(--primary-color);
        }
        
        .product-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-top: 2rem;
        }
        
        .product-image {
            width: 100%;
            height: 400px;
            object-fit: contain;
            background: #f8fafc;
            padding: 2rem;
        }
        
        .product-info {
            padding: 2.5rem;
        }
        
        .product-price {
            color: var(--success-color);
            font-weight: 700;
            font-size: 2rem;
        }
        
        .product-meta {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
        }
        
        .loading {
            text-align: center;
            padding: 4rem;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e2e8f0;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .back-btn {
            margin-top: 1rem;
            margin-bottom: 1rem;
            padding-left: 0;
        }
        
        .specs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .spec-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 10px;
        }
        
        .spec-label {
            font-weight: 600;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .spec-value {
            font-weight: 700;
            color: #1e293b;
            margin-top: 0.25rem;
        }
        
        .error-alert {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }
        
        .reviews-section {
            margin-top: 4rem;
            padding: 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
        }
        
        .review-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .review-author {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .review-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .review-rating .star {
            color: #fbbf24;
        }
        
        .review-date {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .review-text {
            color: #1e293b;
            line-height: 1.6;
            margin: 0;
        }
        
        .no-reviews {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }
        
        .add-review-form {
            background: #f8fafc;
            border-radius: 12px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .star-rating {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .star-rating i {
            font-size: 1.8rem;
            color: #cbd5e1;
            cursor: pointer;
        }
        
        .star-rating i.active {
            color: #fbbf24;
        }
        
        .review-textarea {
            width: 100%;
            min-height: 120px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            resize: vertical;
        }
        
        .similar-products {
            margin-top: 4rem;
        }
        
        .similar-product-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }
        
        .similar-product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .similar-product-content {
            padding: 1rem;
        }
        
        .similar-product-title {
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .similar-product-price {
            color: var(--success-color);
            font-weight: 700;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="bi bi-lightning-charge-fill"></i> FB - Fast Buy
            </a>
            <div class="d-flex align-items-center">
                <a href="index.html" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-left me-1"></i>Назад к списку
                </a>
            </div>
        </div>
    </nav>

    <div class="container" id="app">
        <div class="back-btn">
            <a href="index.html" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Вернуться к товарам
            </a>
        </div>
        
        <div v-if="loading" class="loading">
            <div class="spinner"></div>
            <p class="text-muted mt-3">Загружаем информацию о товаре...</p>
        </div>
        
        <div v-if="error" class="error-alert">
            <h5><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i> Ошибка</h5>
            <p>{{ error }}</p>
            <a href="index.html" class="btn btn-primary mt-2">Вернуться на главную</a>
        </div>
        
        <div v-if="!loading && !error && product" class="product-container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="product-image-container">
                        <img v-if="product.image || product.image_url" 
                             :src="getImageUrl(product)" 
                             :alt="product.title" 
                             class="product-image"
                             @error="handleImageError">
                        <div v-else class="d-flex align-items-center justify-content-center h-100">
                            <div class="text-center">
                                <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                                <p class="text-muted mt-3">Нет изображения</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-lg-6">
                    <div class="product-info">
                        <span v-if="product.category" class="badge bg-primary mb-3">
                            {{ getCategoryName(product.category) }}
                        </span>
                        
                        <h1 class="mb-3">{{ product.title }}</h1>
                        
                        <div class="product-price mb-4">
                            {{ formatPrice(product.price) }} ₽
                        </div>
                        
                        <div class="product-description mb-4">
                            <h5>Описание</h5>
                            <p style="white-space: pre-line;">{{ product.description }}</p>
                        </div>
                        
                        <div class="product-meta">
                            <div class="specs-grid">
                                <div class="spec-item">
                                    <div class="spec-label">Продавец</div>
                                    <div class="spec-value">{{ product.user || 'Администратор' }}</div>
                                </div>
                                
                                <div class="spec-item">
                                    <div class="spec-label">Добавлен</div>
                                    <div class="spec-value">{{ formatDate(product.created_at) }}</div>
                                </div>
                                
                                <div class="spec-item">
                                    <div class="spec-label">Обновлен</div>
                                    <div class="spec-value">{{ formatDate(product.updated_at) }}</div>
                                </div>
                                
                                <div class="spec-item">
                                    <div class="spec-label">ID товара</div>
                                    <div class="spec-value">#{{ product.id }}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <button class="btn btn-primary btn-lg w-100 py-3" @click="addToCart">
                                <i class="bi bi-cart-plus me-2"></i>Добавить в корзину
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div v-if="!loading && !error && product" class="reviews-section">
            <h3 class="mb-4">
                <i class="bi bi-chat-square-text me-2"></i>Отзывы о товаре
                <span class="badge bg-secondary ms-2">{{ reviews.length }}</span>
            </h3>
            
            <div v-if="reviews.length > 0">
                <div v-for="review in reviews" :key="review.id" class="review-card">
                    <div class="review-header">
                        <div class="review-author">
                            <i class="bi bi-person-circle"></i>
                            <strong>{{ review.author }}</strong>
                        </div>
                        <div class="review-rating">
                            <div v-for="star in 5" :key="star" class="star">
                                <i class="bi" :class="star <= review.rating ? 'bi-star-fill' : 'bi-star'"></i>
                            </div>
                        </div>
                    </div>
                    <div class="review-date mb-2">
                        {{ formatDate(review.created_at) }}
                    </div>
                    <p class="review-text">{{ review.text }}</p>
                </div>
            </div>
            
            <div v-else class="no-reviews">
                <i class="bi bi-chat-square" style="font-size: 3rem;"></i>
                <h5 class="mt-3">Пока нет отзывов</h5>
                <p class="text-muted">Будьте первым, кто оставит отзыв об этом товаре!</p>
            </div>
            
            <div class="add-review-form">
                <h5 class="mb-3">Оставить отзыв</h5>
                
                <div class="star-rating mb-3">
                    <i v-for="star in 5" 
                       :key="star" 
                       class="bi" 
                       :class="star <= newReview.rating ? 'bi-star-fill active' : 'bi-star'"
                       @click="newReview.rating = star"></i>
                </div>
                
                <div class="mb-3">
                    <input type="text" 
                           class="form-control" 
                           placeholder="Ваше имя" 
                           v-model="newReview.author">
                </div>
                
                <div class="mb-3">
                    <textarea 
                        class="review-textarea" 
                        placeholder="Ваш отзыв о товаре..."
                        v-model="newReview.text"></textarea>
                </div>
                
                <button class="btn btn-primary" @click="addReview" :disabled="!canSubmitReview">
                    <i class="bi bi-send me-1"></i>Отправить отзыв
                </button>
            </div>
        </div>
        
        <div v-if="!loading && !error && similarProducts.length > 0" class="similar-products">
            <h3 class="mb-4">
                <i class="bi bi-grid me-2"></i>Похожие товары
            </h3>
            
            <div class="row g-4">
                <div v-for="similar in similarProducts" :key="similar.id" class="col-md-3">
                    <a :href="'product_detail.html?id=' + similar.id" class="text-decoration-none text-dark">
                        <div class="similar-product-card">
                            <img :src="getImageUrl(similar)" 
                                 :alt="similar.title" 
                                 class="similar-product-image">
                            <div class="similar-product-content">
                                <h6 class="similar-product-title">{{ similar.title }}</h6>
                                <div class="similar-product-price">
                                    {{ formatPrice(similar.price) }} ₽
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        
        <div class="mt-4 mb-4">
            <a href="index.html" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Вернуться к списку товаров
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <script>
    const { createApp, ref, computed, onMounted } = Vue;
    
    createApp({
        setup() {
            const product = ref(null);
            const loading = ref(true);
            const error = ref(null);
            const reviews = ref([]);
            const similarProducts = ref([]);
            
            const newReview = ref({
                rating: 0,
                author: '',
                text: ''
            });
            
            const canSubmitReview = computed(() => {
                return newReview.value.rating > 0 && 
                       newReview.value.author.trim() !== '' && 
                       newReview.value.text.trim() !== '';
            });
            
            const getProductId = () => {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get('id');
            };
            
            const getImageUrl = (product) => {
                if (product.image) {
                    if (product.image.startsWith('http')) {
                        return product.image;
                    }
                    if (product.image.startsWith('/media/')) {
                        return `http://localhost:8000${product.image}`;
                    }
                    return `http://localhost:8000/media/${product.image}`;
                }
                
                if (product.image_url) {
                    return product.image_url;
                }
                
                return `https://picsum.photos/600/400?random=${product.id}`;
            };
            
            const handleImageError = (event) => {
                event.target.src = `https://picsum.photos/600/400?random=${product.value.id + 1000}`;
            };
            
            const getCategoryName = (category) => {
                if (!category) return 'Без категории';
                
                if (typeof category === 'object' && category.name) {
                    return category.name;
                }
                
                return 'Категория';
            };
            
            const formatPrice = (price) => {
                const num = parseFloat(price) || 0;
                return num.toLocaleString('ru-RU', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            };
            
            const formatDate = (dateString) => {
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch {
                    return 'Не указана';
                }
            };
            
            const addToCart = () => {
                alert('Товар добавлен в корзину!');
            };
            
            const loadReviews = async () => {
                try {
                    const productId = getProductId();
                    if (!productId) return;
                    
                    const response = await axios.get(`http://localhost:8000/api/reviews/by_product/?product_id=${productId}`);
                    reviews.value = response.data;
                    
                } catch (err) {
                    reviews.value = [];
                }
            };
            
            const addReview = async () => {
                if (!canSubmitReview.value) return;
                
                try {
                    const productId = getProductId();
                    
                    const reviewData = {
                        product: productId,
                        author: newReview.value.author.trim(),
                        rating: newReview.value.rating,
                        text: newReview.value.text.trim()
                    };
                    
                    const response = await axios.post('http://localhost:8000/api/reviews/', reviewData);
                    
                    reviews.value.unshift(response.data);
                    
                    newReview.value = {
                        rating: 0,
                        author: '',
                        text: ''
                    };
                    
                    alert('Спасибо за ваш отзыв!');
                    
                } catch (err) {
                    alert('Ошибка при отправке отзыва. Попробуйте снова.');
                }
            };
            
            const loadSimilarProducts = async () => {
                try {
                    if (!product.value || !product.value.category) return;
                    
                    const response = await axios.get('http://localhost:8000/api/products/');
                    const allProducts = response.data.results || response.data || [];
                    
                    similarProducts.value = allProducts
                        .filter(p => p.id !== product.value.id && p.category && p.category.id === product.value.category.id)
                        .slice(0, 4);
                        
                } catch (err) {
                    similarProducts.value = [];
                }
            };
            
            const loadProduct = async () => {
                try {
                    loading.value = true;
                    error.value = null;
                    
                    const productId = getProductId();
                    
                    if (!productId) {
                        throw new Error('ID товара не указан');
                    }
                    
                    const response = await axios.get(`http://localhost:8000/api/products/${productId}/`);
                    product.value = response.data;
                    
                    document.title = `${product.value.title} - FB Fast Buy`;
                    
                    await loadReviews();
                    await loadSimilarProducts();
                    
                } catch (err) {
                    if (err.response && err.response.status === 404) {
                        error.value = 'Товар не найден';
                    } else if (err.message.includes('Network')) {
                        error.value = 'Ошибка подключения к серверу';
                    } else {
                        error.value = err.message || 'Не удалось загрузить информацию о товаре';
                    }
                } finally {
                    loading.value = false;
                }
            };
            
            onMounted(() => {
                loadProduct();
            });
            
            return {
                product,
                loading,
                error,
                reviews,
                similarProducts,
                newReview,
                canSubmitReview,
                getImageUrl,
                handleImageError,
                getCategoryName,
                formatPrice,
                formatDate,
                addToCart,
                addReview
            };
        }
    }).mount('#app');
    </script>
</body>
</html>